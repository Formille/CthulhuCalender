<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ê³ ì„œ - 365 ì–´ë“œë²¤ì²˜: í¬íˆ´ë£¨</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .month-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .month-tab {
            padding: 10px 20px;
            background: rgba(139, 69, 19, 0.3);
            border: 1px solid #8b4513;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .month-tab:hover,
        .month-tab.active {
            background: #8b4513;
            color: #fff;
        }
        .statistics-section {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
            margin-bottom: 30px;
        }
        .statistics-section h2 {
            color: #d4af37;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #555;
        }
        .stat-label {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .stat-value {
            color: #d4af37;
            font-size: 1.5em;
            font-weight: bold;
        }
        .report-entries {
            display: grid;
            gap: 20px;
        }
        .report-entry {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
        }
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        .entry-date {
            font-size: 1.2em;
            color: #d4af37;
            font-weight: bold;
        }
        .prompt-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 3px solid #d4af37;
        }
        .prompt-info h4 {
            color: #d4af37;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .prompt-info-section {
            margin-bottom: 10px;
        }
        .prompt-info-section:last-child {
            margin-bottom: 0;
        }
        .prompt-info-section strong {
            color: #fff;
        }
        .prompt-info-section span {
            color: #ccc;
        }
        .entry-content {
            line-height: 1.8;
            color: #e0e0e0;
        }
        .entry-content h1,
        .entry-content h2,
        .entry-content h3 {
            color: #d4af37;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .entry-content p {
            margin-bottom: 1em;
        }
        .entry-content strong {
            color: #fff;
            font-weight: bold;
        }
        .entry-content em {
            font-style: italic;
            color: #d4af37;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ì¡°ì‚¬ ë³´ê³ ì„œ</h1>
            <p class="subtitle"><!-- ê³„ì‚° ê°’ ë“¤ì–´ê°--></p>
            <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
            <nav class="main-nav">
                <a href="/" class="nav-link">í™ˆ</a>
                <a href="/play" class="nav-link">ê¸°ë¡í•˜ê¸°</a>
                <a href="/diary" class="nav-link">ì¼ê¸°ì¥</a>
                <a href="/report" class="nav-link active">ë³´ê³ ì„œ</a>
            </nav>
        </header>

        <div class="report-container">
            <!-- ì›”ë³„ íƒ­ -->
            <div class="month-tabs" id="month-tabs">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>

            <!-- í†µê³„ ì„¹ì…˜ -->
            <div id="statistics-section" class="statistics-section" style="display: none;">
                <h2>ì›”ë³„ í†µê³„</h2>
                <div class="stat-grid" id="stat-grid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>

            <!-- ì›”ê°„ ë‹¬ë ¥ -->
            <div id="calendar-section" class="statistics-section" style="display: none;">
                <h2>ì›”ê°„ ë‹¬ë ¥</h2>
                <div class="calendar-month">
                    <div class="month-grid" id="month-grid">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>
            </div>

            <!-- ë³´ê³ ì„œ ëª©ë¡ -->
            <div class="report-entries" id="report-entries">
                <div class="loading">ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentMonth = null;
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
        const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”',
                           '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCampaignYear();
            await loadAllChapters();
        });

        // ìº í˜ì¸ ì—°ë„ ë¡œë“œ
        async function loadCampaignYear() {
            const response = await fetch(`${API_BASE}/api/game/state`);
            const data = await response.json();

            if (data.success) {
                const subtitle = document.querySelector('.subtitle');
                if (subtitle) {
                    const campaignYear = data.campaign_year || 1925;
                    subtitle.textContent = `${campaignYear}ë…„ì˜ ì¡°ì‚¬ ë³´ê³ ì„œ`;
                }
            }
        }

        // ëª¨ë“  ì±•í„° ë¡œë“œ
        async function loadAllChapters() {
            try {
                const response = await fetch(`${API_BASE}/api/narrative/all-chapters`);
                const data = await response.json();
                
                if (data.success) {
                    const monthTabs = document.getElementById('month-tabs');
                    monthTabs.innerHTML = '';
                    
                    if (data.chapters.length === 0) {
                        document.getElementById('report-entries').innerHTML = 
                            '<div class="error">ì•„ì§ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }
                    
                    // í”„ë¡¤ë¡œê·¸ì™€ ì¼ë°˜ ì±•í„° ë¶„ë¦¬
                    const prologueChapter = data.chapters.find(c => c.is_prologue);
                    const regularChapters = data.chapters.filter(c => !c.is_prologue);
                    
                    // ì¼ë°˜ ì±•í„°ë¥¼ ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ì›”ì´ ì•ì— ì˜¤ë„ë¡)
                    const sortedChapters = [...regularChapters].reverse();
                    
                    // ì²« ë²ˆì§¸ ì›”ì„ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒ (ìµœì‹ ì›”)
                    if (sortedChapters.length > 0) {
                        currentMonth = sortedChapters[0].month;
                    }
                    
                    // ì¼ë°˜ ì±•í„° íƒ­ ì¶”ê°€ (ìµœì‹ ì›”ë¶€í„°)
                    sortedChapters.forEach(chapter => {
                        const tab = document.createElement('div');
                        tab.className = 'month-tab';
                        tab.textContent = getMonthName(chapter.month);
                        tab.dataset.month = chapter.month;
                        
                        if (chapter.month === currentMonth) {
                            tab.classList.add('active');
                        }
                        
                        tab.addEventListener('click', () => loadMonth(chapter.month));
                        monthTabs.appendChild(tab);
                    });
                    
                    // ê°€ì¥ ìµœì‹  ì›”ì˜ ë³´ê³ ì„œë¥¼ ë¨¼ì € í‘œì‹œ
                    if (sortedChapters.length > 0) {
                        await loadMonth(currentMonth);
                    }
                }
            } catch (error) {
                console.error('ì±•í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('report-entries').innerHTML = 
                    '<div class="error">ë³´ê³ ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì›”ë³„ ë³´ê³ ì„œ ë¡œë“œ
        async function loadMonth(month) {
            currentMonth = month;
            
            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.month === month);
            });
            
            try {
                const response = await fetch(`${API_BASE}/api/narrative/report/${month}`);
                const data = await response.json();
                
                if (data.success) {
                    // í†µê³„ í‘œì‹œ
                    displayStatistics(data.statistics, data.campaign_year, month);
                    
                    // ë‹¬ë ¥ ì´ˆê¸°í™”
                    await initializeMonthCalendar(month, data.campaign_year, data.entries);
                    
                    // ë³´ê³ ì„œ ëª©ë¡ ìˆ¨ê¹€ (ì¼ì¼ ì •ë³´ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
                    const entriesDiv = document.getElementById('report-entries');
                    entriesDiv.innerHTML = '';
                }
            } catch (error) {
                console.error('ì›”ë³„ ë³´ê³ ì„œ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('report-entries').innerHTML = 
                    '<div class="error">ë³´ê³ ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // í†µê³„ í‘œì‹œ
        function displayStatistics(stats, campaignYear, month) {
            const statSection = document.getElementById('statistics-section');
            const statGrid = document.getElementById('stat-grid');
            
            statGrid.innerHTML = '';
            
            const statItems = [
                { label: 'ì´ë²ˆë‹¬ ì ìˆ˜', value: `${stats.monthly_score || 0}ì ` },
                { label: 'ì „ì²´ ì¡°ìš°', value: `${stats.total_entries}ê±´` },
                { label: 'ì„±ê³µ', value: `${stats.success_count}ê±´ (${stats.success_rate}%)` },
                { label: 'ì¼ìš”ì¼ ì¡°ìš° ì„±ê³µ', value: `${stats.sunday_success_count}/${stats.sunday_total_count} (${stats.sunday_success_rate}%)` },
                { label: 'ê´‘ê¸° ë°œì‘ íšŸìˆ˜', value: `${stats.madness_triggered_count}íšŒ` },
                { label: 'ì „íˆ¬ (ê¶Œì´)', value: `${stats.action_type_counts.COMBAT || 0}ê±´` },
                { label: 'ì¡°ì‚¬ (ë‹ë³´ê¸°)', value: `${stats.action_type_counts.INVESTIGATION || 0}ê±´` },
                { label: 'ìˆ˜ìƒ‰ (ì†ì „ë“±)', value: `${stats.action_type_counts.SEARCH || 0}ê±´` }
            ];
            
            statItems.forEach(item => {
                const statItem = document.createElement('div');
                statItem.className = 'stat-item';
                statItem.innerHTML = `
                    <div class="stat-label">${item.label}</div>
                    <div class="stat-value">${item.value}</div>
                `;
                statGrid.appendChild(statItem);
            });
            
            statSection.style.display = 'block';
        }

        function getMonthName(month) {
            const index = months.indexOf(month);
            return index !== -1 ? monthNames[index] : month;
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ê¶Œì´ SVG ì•„ì´ì½˜ ë¡œë“œ í•¨ìˆ˜
        async function loadPistolIcon(container) {
            try {
                const response = await fetch(`${API_BASE}/static/images/pistol.svg`);
                const svgText = await response.text();
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                const svgElement = svgDoc.querySelector('svg');
                if (svgElement) {
                    svgElement.setAttribute('width', '20');
                    svgElement.setAttribute('height', '20');
                    svgElement.setAttribute('style', 'display: inline-block; vertical-align: middle;');
                    const path = svgElement.querySelector('path');
                    if (path) {
                        path.setAttribute('fill', 'currentColor');
                        path.setAttribute('stroke', 'currentColor');
                    }
                    container.innerHTML = '';
                    container.appendChild(svgElement);
                }
            } catch (error) {
                console.error('ê¶Œì´ ì•„ì´ì½˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.textContent = 'ğŸ”«';
            }
        }

        // ë‹ë³´ê¸° SVG ì•„ì´ì½˜ ë¡œë“œ í•¨ìˆ˜
        async function loadSearchIcon(container) {
            try {
                const response = await fetch(`${API_BASE}/static/images/search.svg`);
                const svgText = await response.text();
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                const svgElement = svgDoc.querySelector('svg');
                if (svgElement) {
                    svgElement.setAttribute('width', '20');
                    svgElement.setAttribute('height', '20');
                    svgElement.setAttribute('style', 'display: inline-block; vertical-align: middle;');
                    // currentColorë¡œ stroke ë³€ê²½
                    const circle = svgElement.querySelector('circle');
                    const line = svgElement.querySelector('line');
                    if (circle) {
                        circle.setAttribute('stroke', 'currentColor');
                    }
                    if (line) {
                        line.setAttribute('stroke', 'currentColor');
                    }
                    container.innerHTML = '';
                    container.appendChild(svgElement);
                }
            } catch (error) {
                console.error('ë‹ë³´ê¸° ì•„ì´ì½˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.textContent = 'ğŸ”';
            }
        }

        // ì†ì „ë“± SVG ì•„ì´ì½˜ ë¡œë“œ í•¨ìˆ˜
        async function loadFlashlightIcon(container) {
            try {
                const response = await fetch(`${API_BASE}/static/images/flashlight.svg`);
                const svgText = await response.text();
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                const svgElement = svgDoc.querySelector('svg');
                if (svgElement) {
                    svgElement.setAttribute('width', '20');
                    svgElement.setAttribute('height', '20');
                    svgElement.setAttribute('style', 'display: inline-block; vertical-align: middle;');
                    const path = svgElement.querySelector('path');
                    const line = svgElement.querySelector('line');
                    if (path) {
                        path.setAttribute('fill', 'currentColor');
                        path.setAttribute('stroke', 'currentColor');
                    }
                    if (line) {
                        line.setAttribute('stroke', 'currentColor');
                    }
                    container.innerHTML = '';
                    container.appendChild(svgElement);
                }
            } catch (error) {
                console.error('ì†ì „ë“± ì•„ì´ì½˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.textContent = 'ğŸ”¦';
            }
        }

        // ì›”ê°„ ë‹¬ë ¥ ì´ˆê¸°í™”
        async function initializeMonthCalendar(monthName, campaignYear, entries) {
            const monthGrid = document.getElementById('month-grid');
            monthGrid.innerHTML = '';
            
            // ì›” ì´ë¦„ì„ ìˆ«ìë¡œ ë³€í™˜
            const monthIndex = months.indexOf(monthName);
            if (monthIndex === -1) return;
            
            const currentYear = campaignYear;
            const currentMonth = monthIndex;
            
            // ì™„ë£Œëœ ë‚ ì§œ ëª©ë¡ ìˆ˜ì§‘
            let completedDates = new Set();
            if (entries) {
                entries.forEach(entry => {
                    // entry.dateëŠ” "YYYY-MM-DD" í˜•ì‹
                    if (entry.date && entry.prompt_info?.result?.judgment === 'ì„±ê³µ') {
                        completedDates.add(entry.date);
                    }
                });
            }
            
            // ì¡°ìš° ë°ì´í„° ë¡œë“œ
            let encounterData = null;
            try {
                const encounterResponse = await fetch(`${API_BASE}/api/game/encounter-data`);
                const encounterResult = await encounterResponse.json();
                if (encounterResult.success) {
                    encounterData = encounterResult.data;
                }
            } catch (error) {
                console.error('ì¡°ìš° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            
            // ìš”ì¼ í—¤ë” ì¶”ê°€
            const dayHeaders = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            dayHeaders.forEach(dayName => {
                const headerCell = document.createElement('div');
                headerCell.className = 'month-header-cell';
                if (dayName === 'ì¼') {
                    headerCell.classList.add('sunday-header');
                }
                headerCell.textContent = dayName;
                monthGrid.appendChild(headerCell);
            });
            
            // ì›”ì˜ ì²« ë‚ ì§œì™€ ë§ˆì§€ë§‰ ë‚ ì§œ ê³„ì‚°
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // ì²« ë‚ ì˜ ìš”ì¼ (0=ì¼ìš”ì¼, 1=ì›”ìš”ì¼, ...)
            const firstDayOfWeek = firstDay.getDay();
            
            // ì²« ì£¼ì˜ ë¹ˆ ì¹¸ ì¶”ê°€ (ì›”ìš”ì¼ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ ì¼ìš”ì¼ì´ë©´ 6ì¹¸, ì›”ìš”ì¼ì´ë©´ 0ì¹¸)
            const daysToMonday = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            for (let i = 0; i < daysToMonday; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'month-day-cell empty';
                monthGrid.appendChild(emptyCell);
            }
            
            // ë‚ ì§œ ì…€ ì¶”ê°€
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(currentYear, currentMonth, day);
                const dateStr = formatDate(dayDate);
                const isCompleted = completedDates.has(dateStr);
                const dayOfWeek = dayDate.getDay();
                const isSunday = dayOfWeek === 0;
                
                const dayCell = document.createElement('div');
                dayCell.className = 'month-day-cell';
                if (isSunday) {
                    dayCell.classList.add('sunday');
                }
                if (isCompleted) {
                    dayCell.classList.add('completed');
                }
                dayCell.dataset.date = dateStr;
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                
                const dayDateLabel = document.createElement('div');
                dayDateLabel.className = 'day-date-label';
                const month = String(currentMonth + 1).padStart(2, '0');
                const dayStr = String(day).padStart(2, '0');
                const dateKey = `${month}-${dayStr}`;
                
                // ì¡°ìš° ë°ì´í„°ì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                let difficulty = '';
                let currentEncounter = null;
                if (encounterData && encounterData.encounters && encounterData.encounters[dateKey]) {
                    currentEncounter = encounterData.encounters[dateKey];
                    difficulty = currentEncounter.base_difficulty || '';
                    
                    // ì•„ì´ì½˜ê³¼ ë‚œì´ë„ë¥¼ ìŠ¬ë˜ì‹œë¡œ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'action-icon';
                    
                    // ê¶Œì´(COMBAT)ì¸ ê²½ìš° ì»¤ìŠ¤í…€ SVG ì‚¬ìš©
                    if (currentEncounter.required_action === 1) {
                        await loadPistolIcon(iconSpan);
                    } else if (currentEncounter.required_action === 2) {
                        // ë‹ë³´ê¸°(INVESTIGATION)ì¸ ê²½ìš° ì»¤ìŠ¤í…€ SVG ì‚¬ìš©
                        await loadSearchIcon(iconSpan);
                    } else if (currentEncounter.required_action === 3) {
                        // ì†ì „ë“±(SEARCH)ì¸ ê²½ìš° ì»¤ìŠ¤í…€ SVG ì‚¬ìš©
                        await loadFlashlightIcon(iconSpan);
                    }
                    
                    const difficultySpan = document.createElement('span');
                    difficultySpan.className = 'difficulty-value';
                    difficultySpan.textContent = difficulty || '';
                    
                    dayDateLabel.appendChild(iconSpan);
                    if (difficulty) {
                        const separator = document.createTextNode(' / ');
                        dayDateLabel.appendChild(separator);
                        dayDateLabel.appendChild(difficultySpan);
                    }
                }
                
                dayCell.appendChild(dayNumber);
                dayCell.appendChild(dayDateLabel);
                
                // ì½ê¸° ì „ìš©ì´ë¯€ë¡œ í´ë¦­ ë¶ˆê°€ëŠ¥í•˜ê²Œ ì„¤ì •
                dayCell.style.cursor = 'default';
                dayCell.style.pointerEvents = 'none';
                
                monthGrid.appendChild(dayCell);
            }
            
            // ë‹¬ë ¥ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('calendar-section').style.display = 'block';
        }
    </script>
</body>
</html>

